<!DOCTYPE html>
<html>
<head>
    <title>Order Waiting</title>
    <style>
        /* 狀態顯示區域樣式 */
        #statusCorner {
            position: relative;
            margin-bottom: 10px;
            background-color: rgb(107, 147, 219);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
            text-align: left;
        }

        /* 隱藏按鈕 */
        #updateButton {
            display: none;
        }
    </style>
    <script>
        // 禁止頁面離開
        window.onbeforeunload = function() {
            return "Your order is still being processed. Are you sure you want to leave?";
        };

        // 每隔 5 秒檢查訂單狀態
        function checkOrderStatus(orderId) {
            fetch(`/customer/check_order_status/${orderId}`)
            .then(response => response.json())
            .then(data => {
                // 從嵌套的 status 對象中獲取數據
                const orderStatus = data.status.order_status;
                const paymentStatus = data.status.payment_status;

                console.log('Order Status:', orderStatus);
                console.log('Payment Status:', paymentStatus);

                // 更新顯示
                const orderStatusText = document.getElementById('orderStatus');
                if (orderStatus === 'PREPARING') {
                    orderStatusText.innerText = 'Order Status: 餐點正在製作中';
                } else if (orderStatus === 'OUT_FOR_DELIVERY') {
                    orderStatusText.innerText = 'Order Status: 外送員正在路上';
                } else if (orderStatus === 'DELIVERED') {
                        orderStatusText.innerText = 'Order Status: 外送員已抵達';
                } else if (orderStatus === 'GET') {
                        orderStatusText.innerText = 'Order Status: 已確認取餐';
                } else {
                    orderStatusText.innerText = `Order Status: ${orderStatus}`;
                }

                const paymentStatusText = document.getElementById('paymentStatus');
                if (paymentStatus === 'PENDING') {
                    paymentStatusText.innerText = 'Payment Status: 未付款';
                }  else {
                    paymentStatusText.innerText = `Payment Status: ${paymentStatus}`;
                }

                // 檢查是否顯示按鈕
                const updateButton = document.getElementById('updateButton');
                if (orderStatus === 'DELIVERED') {
                    updateButton.style.display = 'block';
                } else {
                    updateButton.style.display = 'none';
                }

                // 檢查是否完成
                if (orderStatus === 'GET' && paymentStatus === 'COMPLETED') {
                    window.onbeforeunload = null;
                    window.location.href = `/customer/success?order_id=${orderId}`;
                }
            })
            .catch(error => console.error('Error checking order status:', error));
        }

        document.addEventListener('DOMContentLoaded', function() {
            const orderId = {{ order_id | tojson | safe }};
            console.log('DEBUG: orderId =', orderId); // 調試信息
            setInterval(function() {
                checkOrderStatus(orderId);
            }, 2000);
        });
    </script>
</head>
<body>
    <h1>Your order is being processed...</h1>
    <p>Please do not leave this page until your order is complete.</p>

    <!-- 狀態顯示區域 -->
    <div id="statusCorner">
        <p id="orderStatus">Order Status: Loading...</p>
        <p id="paymentStatus">Payment Status: Loading...</p>
    </div>

    <!-- 狀態更新按鈕 -->
    <form id="updateButton" action="{{ url_for('customer.update_order_status_route', order_id=order_id) }}" method="POST">
        <button type="submit">確定取餐</button>
        <p>注意!!請在確認收到餐點後再點擊確認.</p>
    </form>
</body>
</html>
